<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>jTopo 5层星形树（带右键菜单）</title>
    <script src="https://cdn.jsdelivr.net/npm/jtopo@2.4.4/dist/jtopo.min.js"></script>
    <style>
        .tree-container {
            width: 100%;
            height: 300px;
            border: 1px solid #eee;
            margin: 20px 0;
            position: relative; /* 为右键菜单定位 */
        }
        h3 { margin: 10px 0 5px; color: #333; }
        /* 右键菜单样式 */
        .right-menu {
            position: absolute;
            width: 100px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
            z-index: 9999;
        }
        .right-menu div {
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
        }
        .right-menu div:hover {
            background: #f5f5f5;
            color: #409EFF;
        }
    </style>
</head>
<body>
    <h2>3颗5层机构星形树（支持右键菜单）</h2>

    <!-- 第一颗树容器 + 右键菜单 -->
    <h3>团队1 - 机构树</h3>
    <div id="tree1" class="tree-container">
        <div id="menu1" class="right-menu">
            <div data-action="new">新建</div>
            <div data-action="delete">删除</div>
            <div data-action="query">查询</div>
        </div>
    </div>

    <!-- 第二颗树容器 + 右键菜单 -->
    <h3>团队2 - 机构树</h3>
    <div id="tree2" class="tree-container">
        <div id="menu2" class="right-menu">
            <div data-action="new">新建</div>
            <div data-action="delete">删除</div>
            <div data-action="query">查询</div>
        </div>
    </div>

    <!-- 第三颗树容器 + 右键菜单 -->
    <h3>团队3 - 机构树</h3>
    <div id="tree3" class="tree-container">
        <div id="menu3" class="right-menu">
            <div data-action="new">新建</div>
            <div data-action="delete">删除</div>
            <div data-action="query">查询</div>
        </div>
    </div>

    <script>
        // 初始化星形树（含右键菜单）
        function initStarTree(containerId, teamName, menuId) {
            // 1. 创建舞台与场景
            const stage = new JTopo.Stage(containerId);
            const scene = new JTopo.Scene(stage);
            scene.background = '#fafafa';
            const rightMenu = document.getElementById(menuId);
            let currentNode = null; // 记录当前右键点击的节点

            // 2. 屏蔽系统右键菜单
            document.getElementById(containerId).addEventListener('contextmenu', e => {
                e.preventDefault(); // 阻止系统菜单
            });

            // 3. 节点右键事件：显示自定义菜单
            scene.on('mouseRightClick', (e) => {
                if (e.target instanceof JTopo.Node) {
                    currentNode = e.target; // 记录点击的节点
                    const container = document.getElementById(containerId);
                    const rect = container.getBoundingClientRect();
                    // 菜单定位（相对于容器，避免超出视口）
                    const menuLeft = e.clientX - rect.left - rightMenu.offsetWidth / 2;
                    const menuTop = e.clientY - rect.top - rightMenu.offsetHeight / 2;
                    rightMenu.style.left = `${Math.max(0, menuLeft)}px`;
                    rightMenu.style.top = `${Math.max(0, menuTop)}px`;
                    rightMenu.style.display = 'block'; // 显示菜单
                } else {
                    rightMenu.style.display = 'none'; // 点击空白处隐藏菜单
                }
            });

            // 4. 点击页面空白处隐藏菜单
            document.addEventListener('click', (e) => {
                if (!rightMenu.contains(e.target) && e.target !== currentNode) {
                    rightMenu.style.display = 'none';
                }
            });

            // 5. 菜单点击事件（执行对应操作）
            rightMenu.addEventListener('click', (e) => {
                if (currentNode && e.target.dataset.action) {
                    const action = e.target.dataset.action;
                    const nodeName = currentNode.text;
                    // 操作逻辑（可根据需求替换为接口请求、节点增删等）
                    switch(action) {
                        case 'new':
                            console.log(`对节点【${nodeName}】执行新建操作`);
                            alert(`新建：基于节点「${nodeName}」创建子节点（可扩展实际逻辑）`);
                            break;
                        case 'delete':
                            console.log(`对节点【${nodeName}】执行删除操作`);
                            scene.remove(currentNode); // 从场景中删除节点
                            alert(`删除：节点「${nodeName}」已移除`);
                            break;
                        case 'query':
                            console.log(`对节点【${nodeName}】执行查询操作`);
                            alert(`查询：节点「${nodeName}」的详情（可扩展实际逻辑）`);
                            break;
                    }
                    rightMenu.style.display = 'none'; // 点击后隐藏菜单
                }
            });

            // 6. 生成5层节点（同之前逻辑，新增节点样式统一）
            const nodeData = {
                team: `${teamName}`,
                project: `${teamName}-项目A`,
                instance: `${teamName}-实例01`,
                db: `${teamName}-数据库`,
                children: ['示图', '存储', '用户']
            };

            // 第1层：Team（中心）
            const teamNode = new JTopo.Node(nodeData.team);
            teamNode.setLocation(stage.width / 2, stage.height / 2);
            teamNode.fontSize = 14;
            teamNode.fontWeight = 'bold';
            teamNode.fillColor = '#409EFF';
            teamNode.textColor = '#fff';
            teamNode.radius = 30;
            scene.add(teamNode);

            // 第2层：Project（上方）
            const projectNode = new JTopo.Node(nodeData.project);
            projectNode.setLocation(stage.width / 2, stage.height / 2 - 80);
            projectNode.fontSize = 12;
            projectNode.fillColor = '#67C23A';
            projectNode.textColor = '#fff';
            projectNode.radius = 24;
            scene.add(projectNode);
            scene.add(new JTopo.Link(teamNode, projectNode, { strokeColor: '#67C23A', strokeWidth: 2 }));

            // 第3层：Instance（右上）
            const instanceNode = new JTopo.Node(nodeData.instance);
            instanceNode.setLocation(stage.width / 2 + 80, stage.height / 2 - 80);
            instanceNode.fontSize = 12;
            instanceNode.fillColor = '#E6A23C';
            instanceNode.textColor = '#fff';
            instanceNode.radius = 24;
            scene.add(instanceNode);
            scene.add(new JTopo.Link(projectNode, instanceNode, { strokeColor: '#E6A23C', strokeWidth: 2 }));

            // 第4层：DB（右中）
            const dbNode = new JTopo.Node(nodeData.db);
            dbNode.setLocation(stage.width / 2 + 80, stage.height / 2);
            dbNode.fontSize = 12;
            dbNode.fillColor = '#F56C6C';
            dbNode.textColor = '#fff';
            dbNode.radius = 24;
            scene.add(dbNode);
            scene.add(new JTopo.Link(instanceNode, dbNode, { strokeColor: '#F56C6C', strokeWidth: 2 }));

            // 第5层：子节点（右下分布）
            const childPositions = [
                [stage.width / 2 + 80, stage.height / 2 + 60],
                [stage.width / 2 + 40, stage.height / 2 + 90],
                [stage.width / 2 + 120, stage.height / 2 + 90]
            ];
            const childColors = ['#909399', '#C0C4CC', '#86909C'];

            nodeData.children.forEach((childName, index) => {
                const childNode = new JTopo.Node(childName);
                childNode.setLocation(childPositions[index][0], childPositions[index][1]);
                childNode.fontSize = 11;
                childNode.fillColor = childColors[index];
                childNode.textColor = '#fff';
                childNode.radius = 20;
                scene.add(childNode);
                scene.add(new JTopo.Link(dbNode, childNode, { strokeColor: childColors[index], strokeWidth: 1.5 }));
            });

            // 7. 启用拖拽和缩放
            stage.mode = 'edit';
            stage.wheelZoom = true;
        }

        // 初始化3颗树
        window.onload = function() {
            initStarTree('tree1', 'Team-01', 'menu1');
            initStarTree('tree2', 'Team-02', 'menu2');
            initStarTree('tree3', 'Team-03', 'menu3');
        };
    </script>
</body>
</html>
